# フィルタ設計ドキュメント

ITU-T G.227 疑似音声信号発生器のフィルタ設計過程を記録した Jupyter Notebook 群。

## 概要

G.227 規格で定義されたアナログフィルタの伝達関数をデジタルフィルタに変換する手法を試行錯誤した記録。最終的に 03 の手法（IIR + FIR 補正）を採用。

### G.227 伝達関数

$$
H(p) = \frac{11638\ p^4 + 54050\ p^3 + 91238\ p^2 + 67280\ p + 18400}{p^4 + 130\ p^3 + 4001\ p^2 + 36040\ p + 400}
$$

$$
p = j \frac{f}{1000}
$$

600Hz 付近にピークを持つ 4 次フィルタ。ホワイトノイズをこのフィルタに通すことで疑似音声信号となる。

---

## 01-complex-to-real-fir.ipynb

**手法**: 周波数特性をそのまま IFFT して FIR フィルタを得る

### 概要

G.227 の周波数特性（ロスの逆数＝ゲイン）を直接 IFFT してインパルス応答を求める。最も単純なアプローチ。

### 処理フロー

1. G.227 伝達関数から周波数特性を計算
2. ロスの逆数をとってゲインに変換
3. IFFT でインパルス応答を取得
4. 実数部のみを取り出して FIR フィルタとする

### 結果

- 複素数フィルタが得られるため、実数部を取り出す際に誤差が発生
- 直感的だが精度に課題あり

---

## 02-real-fir.ipynb

**手法**: 周波数特性を対称にして実数 FIR フィルタを設計

### 概要

FIR フィルタが実数係数になるためには、周波数特性が左右対称（共役対称）である必要がある。この性質を利用して実数フィルタを直接設計。

### 処理フロー

1. G.227 の周波数特性を計算
2. 周波数特性を左右対称に配置（正負両方向）
3. IFFT でインパルス応答を取得
4. 虚数成分を破棄

### 結果

- 低域の減衰が急峻すぎるため、対称にしても虚数成分が残る
- 虚数を破棄して実数フィルタとして評価
- G.227 との誤差が発生し、次数を増やすと改善するが計算コストが増大

### 課題

- 高精度を求めると FIR の長さが非常に長くなる
- 計算コストと精度のトレードオフ

---

## 03-iir-fir.ipynb（採用）

**手法**: 双一次変換で IIR フィルタを作成し、FIR フィルタで補正

### 概要

アナログフィルタの伝達関数が与えられている場合の標準的手法。双一次変換でデジタル IIR フィルタを得て、周波数歪みを FIR フィルタで補正する。

### 処理フロー

1. G.227 の伝達関数を角周波数形式に変換
2. `scipy.signal.bilinear()` で双一次変換 → 4次 IIR フィルタ係数
3. IIR フィルタの周波数特性と理論値の差分を計算
4. 差分を補正する FIR フィルタを設計（97 タップ、Kaiser 窓）
5. 合成特性を評価

### 双一次変換

G.227 の伝達関数を角周波数 ω をとる形式に変換：

$$
p = j \frac{\omega}{2000\pi}
$$

各係数を $(2000\pi)^{-n}$ でスケーリングして `scipy.signal.bilinear()` に渡す。

### 結果

- **4次 IIR フィルタ**: `IIRFilterNode` で実装
- **97タップ FIR フィルタ**: `ConvolverNode` で実装
- **誤差 RMSE**: 全帯域 0.025 dB / G.227 Fig.2 範囲 0.008 dB / 電話帯域 0.007 dB

### 最終出力

この手法を採用し、`scripts/generate_coeffs.py` で複数サンプルレート（44100Hz, 48000Hz）対応の `coeffs.json` を生成している。

---

## ファイル一覧

| ファイル | 説明 |
|---------|------|
| 01-complex-to-real-fir.ipynb | 複素 FIR → 実数 FIR 変換の実験 |
| 02-real-fir.ipynb | 対称周波数特性による実数 FIR 設計 |
| 03-iir-fir.ipynb | 双一次変換 IIR + FIR 補正（採用版） |
| G.227-curve.png | G.227 周波数特性の参考画像 |
| calculate_rms_normalization.py | RMS 正規化係数の計算スクリプト |

## 参考

- [ITU-T G.227](https://www.itu.int/rec/T-REC-G.227-198811-I/en) - Conventional Telephone Signal
